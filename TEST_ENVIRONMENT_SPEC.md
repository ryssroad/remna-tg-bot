# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: –¢–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è Best2Pay –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

## –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ–≥–æ –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ Best2Pay –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–µ–Ω–µ–≥ –∏ –±–µ–∑ —Ä–∏—Å–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω-—Å–∏—Å—Ç–µ–º—ã.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
1. **–¢–µ—Å—Ç–æ–≤–∞—è –ø–∞–Ω–µ–ª—å Remnawave** - –æ—Ç–¥–µ–ª—å–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **–¢–µ—Å—Ç–æ–≤—ã–π Telegram –±–æ—Ç** - –∫–ª–æ–Ω –ø—Ä–æ–¥–∞–∫—à–Ω –±–æ—Ç–∞ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
3. **–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ç–µ–Ω–¥ Best2Pay** - `test.best2pay.net`
4. **–¢–µ—Å—Ç–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ç –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# .env –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–æ—Ç–∞
BOT_TOKEN=<TEST_BOT_TOKEN>
ADMIN_IDS=<YOUR_TELEGRAM_ID>

# PostgreSQL (–æ—Ç–¥–µ–ª—å–Ω–∞—è –ë–î –∏–ª–∏ —Å—Ö–µ–º–∞)
POSTGRES_DB=test_bot_db
POSTGRES_HOST=localhost  # –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

# Test Panel API
PANEL_API_URL=https://test-panel.example.com/api
PANEL_API_KEY=<TEST_PANEL_API_KEY>

# Best2Pay Test Environment
BEST2PAY_SECTOR_ID=8365
BEST2PAY_PASSWORD=I3ssq1q:UiM2ozdvb
BEST2PAY_API_URL=https://test.best2pay.net/webapi/
BEST2PAY_ENABLED=True

# Webhook (ngrok –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ–º–µ–Ω)
WEBHOOK_BASE_URL=https://test-webhook.example.com

# –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã - –≤—ã–∫–ª—é—á–µ–Ω—ã
YOOKASSA_ENABLED=False
STARS_ENABLED=False
TRIBUTE_ENABLED=False
CRYPTOPAY_ENABLED=False
```

---

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### 1. –ê–¥–º–∏–Ω—Å–∫–æ–µ –º–µ–Ω—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–î–æ–±–∞–≤–∏—Ç—å –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Best2Pay"

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—é:

```
/admin
  ‚îî‚îÄ üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Best2Pay
       ‚îú‚îÄ 1Ô∏è‚É£ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
       ‚îú‚îÄ 2Ô∏è‚É£ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂
       ‚îú‚îÄ 3Ô∏è‚É£ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É
       ‚îú‚îÄ 4Ô∏è‚É£ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É
       ‚îú‚îÄ 5Ô∏è‚É£ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É
       ‚îú‚îÄ 6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
       ‚îú‚îÄ 7Ô∏è‚É£ –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
       ‚îî‚îÄ ‚ÑπÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–µ—Å—Ç-–∫–µ–π—Å
```

---

## –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π

### 1Ô∏è‚É£ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π username: `test_user_<timestamp>`
2. –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ —á–µ—Ä–µ–∑ API
3. –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î –±–æ—Ç–∞ (—Ç–∞–±–ª–∏—Ü–∞ `users`)
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ø–∞–Ω–µ–ª–∏

**API –ø–∞–Ω–µ–ª–∏:**
```http
POST /api/users
Authorization: Bearer <PANEL_API_KEY>
Content-Type: application/json

{
  "username": "test_user_1700000000",
  "telegramId": null,
  "email": "test@example.com",
  "subscriptionDurationDays": 0,
  "trafficLimitBytes": 10737418240,  // 10GB
  "subscriptionTrafficStrategy": "NO_RESET",
  "squadUuids": ["<DEFAULT_SQUAD_UUID>"],
  "tags": ["test_user"]
}
```

**Response:**
```json
{
  "uuid": "d50941b5-504e-448d-9c40-32c9b21c6722",
  "shortUuid": "abc123",
  "username": "test_user_1700000000",
  "subscriptionDurationDays": 0,
  "expiresAt": null,
  "trafficLimitBytes": 10737418240,
  "trafficUsedBytes": 0,
  "isActive": false,
  "tags": ["test_user"]
}
```

**–í—ã–≤–æ–¥ –±–æ—Ç—É:**
```
‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω!

Username: test_user_1700000000
UUID: d50941b5-504e-448d-9c40-32c9b21c6722
Short UUID: abc123
Telegram ID: <YOUR_ID>
–°—Ç–∞—Ç—É—Å: –ù–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (–Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏)

üìã –°–∫–æ–ø–∏—Ä—É–π—Ç–µ UUID –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
```

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç:**
- FSM State: `TestingState.user_created`
- FSM Data: `{"test_user_uuid": "...", "test_username": "...", "test_telegram_id": ...}`

---

### 2Ô∏è‚É£ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω (–µ—Å—Ç—å –≤ FSM)
2. –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥ –ø–æ–¥–ø–∏—Å–∫–∏ (1, 3, 6, 12 –º–µ—Å—è—Ü–µ–≤)
3. –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `payments` –≤ –ë–î
4. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –∑–∞–∫–∞–∑ –≤ Best2Pay —á–µ—Ä–µ–∑ `webapi/Register`

**Inline –∫–Ω–æ–ø–∫–∏:**
```
–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –ø–æ–¥–ø–∏—Å–∫–∏:
[1 –º–µ—Å—è—Ü - 300‚ÇΩ] [3 –º–µ—Å—è—Ü–∞ - 850‚ÇΩ]
[6 –º–µ—Å—è—Ü–µ–≤ - 1600‚ÇΩ] [12 –º–µ—Å—è—Ü–µ–≤ - 3000‚ÇΩ]
```

**–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞:**

**–ë–î –∑–∞–ø–∏—Å—å:**
```sql
INSERT INTO payments (
  user_id,
  amount,
  currency,
  status,
  subscription_duration_months,
  provider,
  description
) VALUES (
  <TEST_USER_ID>,
  300.00,
  'RUB',
  'pending_best2pay',
  1,
  'best2pay',
  '–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞'
) RETURNING payment_id;
```

**API Best2Pay:**
```http
POST https://test.best2pay.net/webapi/Register

sector=8365
amount=30000  # –≤ –∫–æ–ø–µ–π–∫–∞—Ö
currency=643  # RUB
reference=<PAYMENT_ID>
description=–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞
url=https://test-webhook.example.com/webhook/best2pay/success
fail_url=https://test-webhook.example.com/webhook/best2pay/fail
signature=<CALCULATED_SIGNATURE>
```

**Response:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<order>
  <id>2804372329</id>
  <state>REGISTERED</state>
</order>
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î:**
```sql
UPDATE payments
SET best2pay_order_id = '2804372329'
WHERE payment_id = <PAYMENT_ID>;
```

**–í—ã–≤–æ–¥ –±–æ—Ç—É:**
```
‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω!

Payment ID (–ë–î): 123
Best2Pay Order ID: 2804372329
–°—É–º–º–∞: 300.00 RUB (30000 –∫–æ–ø–µ–µ–∫)
–ü–µ—Ä–∏–æ–¥: 1 –º–µ—Å—è—Ü
–°—Ç–∞—Ç—É—Å: pending_best2pay

üîÑ –ó–∞–∫–∞–∑ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ Best2Pay
–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É
```

**FSM –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:**
- State: `TestingState.payment_created`
- Data: `{..., "test_payment_id": 123, "test_order_id": "2804372329", "test_months": 1, "test_amount": 300}`

---

### 3Ô∏è‚É£ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ order_id –≤ FSM
2. –í—ã–∑—ã–≤–∞–µ—Ç Best2Pay API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –°–ë–ü —Å—Å—ã–ª–∫–∏
3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç QR-–∫–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã

**API Best2Pay:**
```http
POST https://test.best2pay.net/webapi/PurchaseSBP

sector=8365
order_id=2804372329
payment_method=sbp
signature=<CALCULATED_SIGNATURE>
```

**Response:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<sbp_payment>
  <qrc_id>AS1R000KOMEPGAIE9519CB1Q4PGN6ULN</qrc_id>
  <pay_url>https://test.best2pay.net/sbp/pay/AS1R000KOMEPGAIE9519CB1Q4PGN6ULN</pay_url>
</sbp_payment>
```

**–í—ã–≤–æ–¥ –±–æ—Ç—É:**
```
‚úÖ –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∞!

Order ID: 2804372329
QRC ID: AS1R000KOMEPGAIE9519CB1Q4PGN6ULN
–ú–µ—Ç–æ–¥: –°–ë–ü (Faster Payment System)

üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É:
https://test.best2pay.net/sbp/pay/AS1R000KOMEPGAIE9519CB1Q4PGN6ULN

‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ù–∞ —Ç–µ—Å—Ç–æ–≤–æ–º —Å—Ç–µ–Ω–¥–µ Best2Pay —Ä–µ–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞
—á–µ—Ä–µ–∑ –°–ë–ü –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–º—É–ª—è—Ü–∏—é (—à–∞–≥ 4)

üì≤ –ú–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É (–¥–ª—è —Ç–µ—Å—Ç–∞ UX)
```

**FSM –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:**
- State: `TestingState.payment_url_created`
- Data: `{..., "test_qrc_id": "...", "test_pay_url": "..."}`

---

### 4Ô∏è‚É£ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Ä–≤–∏—Å `test/SBPTestCase` –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
2. Best2Pay –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ –Ω–∞—à —Å–µ—Ä–≤–µ—Ä
3. –ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂
4. –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ Panel API
5. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤ –ë–î

**API Best2Pay:**
```http
POST https://test.best2pay.net/test/SBPTestCase

sector=8365
case_id=150  # —É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞
order_id=2804372329
signature=<CALCULATED_SIGNATURE>
```

**Response:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<SBPTestCase>
  <qrc_id>AS1R000KOMEPGAIE9519CB1Q4PGN6ULN</qrc_id>
  <message>[00150: –Ω–µ –∑–∞–ø—É—â–µ–Ω] –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—É—â–µ–Ω</message>
</SBPTestCase>
```

**–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ Best2Pay –æ—Ç–ø—Ä–∞–≤–∏—Ç webhook:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<operation>
  <order_id>2804372329</order_id>
  <order_state>COMPLETED</order_state>
  <reference>123</reference>
  <id>99999999</id>
  <date>2025.11.18 12:00:00</date>
  <type>PURCHASE_BY_QR</type>
  <state>APPROVED</state>
  <amount>30000</amount>
  <currency>643</currency>
  <signature>...</signature>
</operation>
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞: `pending_best2pay` ‚Üí `succeeded`
3. –í—ã–∑–æ–≤ Panel API –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
4. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**Panel API (–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏):**
```http
POST /api/subscriptions

{
  "userUuid": "d50941b5-504e-448d-9c40-32c9b21c6722",
  "durationDays": 30,
  "trafficLimitBytes": 0,
  "subscriptionTrafficStrategy": "NO_RESET"
}
```

**–í—ã–≤–æ–¥ –±–æ—Ç—É:**
```
‚úÖ –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞!

üîî Webhook –ø–æ–ª—É—á–µ–Ω –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
üí≥ –ü–ª–∞—Ç–µ–∂ #123: pending_best2pay ‚Üí succeeded
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: test_user_1700000000
üìÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ 30 –¥–Ω–µ–π
üìä –¢—Ä–∞—Ñ–∏–∫: –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π

‚úâÔ∏è –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

---

### 5Ô∏è‚É£ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —à–∞–≥—É 4, –Ω–æ:**
- `case_id=151` (–Ω–µ—É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞)
- Webhook —Å–æ–¥–µ—Ä–∂–∏—Ç `state=DECLINED`
- –°—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–µ—Ç—Å—è `pending_best2pay` –∏–ª–∏ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `failed`
- –ü–æ–¥–ø–∏—Å–∫–∞ –ù–ï –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

**–í—ã–≤–æ–¥ –±–æ—Ç—É:**
```
‚ö†Ô∏è –ù–µ—É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞

üîî Webhook –ø–æ–ª—É—á–µ–Ω –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
üí≥ –ü–ª–∞—Ç–µ–∂ #123: pending_best2pay ‚Üí failed
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: test_user_1700000000
‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –ù–ï –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞
–ü—Ä–∏—á–∏–Ω–∞: –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ (—Ç–µ—Å—Ç-–∫–µ–π—Å 151)

‚úâÔ∏è –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

---

### 6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Panel API
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

**Panel API:**
```http
GET /api/users/{uuid}
Authorization: Bearer <PANEL_API_KEY>
```

**Response:**
```json
{
  "uuid": "d50941b5-504e-448d-9c40-32c9b21c6722",
  "username": "test_user_1700000000",
  "subscriptionDurationDays": 30,
  "expiresAt": "2025-12-18T12:00:00Z",
  "isActive": true,
  "trafficLimitBytes": 0,
  "trafficUsedBytes": 1048576,
  "tags": ["test_user"]
}
```

**–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î:**
```sql
SELECT * FROM users WHERE panel_uuid = 'd50941b5-504e-448d-9c40-32c9b21c6722';
SELECT * FROM payments WHERE user_id = <USER_ID> ORDER BY created_at DESC LIMIT 5;
```

**–í—ã–≤–æ–¥ –±–æ—Ç—É:**
```
üìä –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
Username: test_user_1700000000
UUID: d50941b5-504e-448d-9c40-32c9b21c6722
Telegram ID: <YOUR_ID>

üìÖ –ü–æ–¥–ø–∏—Å–∫–∞
–°—Ç–∞—Ç—É—Å: ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞
–ò—Å—Ç–µ–∫–∞–µ—Ç: 2025-12-18 12:00:00 UTC
–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: 30

üìä –¢—Ä–∞—Ñ–∏–∫
–õ–∏–º–∏—Ç: –ë–µ–∑–ª–∏–º–∏—Ç
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: 1.00 MB
–û—Å—Ç–∞–ª–æ—Å—å: ‚àû

üí≥ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏
1. #123 - succeeded - 300 RUB - 2025-11-18 (Best2Pay)

üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
[–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é]
```

---

### 7Ô∏è‚É£ –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –£–¥–∞–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Panel API
2. –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î (users, payments)
3. –û—á–∏—â–∞–µ—Ç FSM state
4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ—á–∏—Å—Ç–∫—É

**Confirmation dialog:**
```
‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã?

–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã:
‚Ä¢ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø–∞–Ω–µ–ª–∏
‚Ä¢ –ó–∞–ø–∏—Å–∏ –≤ –ë–î (users, payments)
‚Ä¢ FSM –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ —Ç–µ—Å—Ç-–∫–µ–π—Å–∞

[‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å] [‚ùå –û—Ç–º–µ–Ω–∞]
```

**Panel API:**
```http
DELETE /api/users/{uuid}
Authorization: Bearer <PANEL_API_KEY>
```

**–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î:**
```sql
DELETE FROM payments WHERE user_id = <TEST_USER_ID>;
DELETE FROM users WHERE id = <TEST_USER_ID>;
```

**–í—ã–≤–æ–¥ –±–æ—Ç—É:**
```
‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã

–£–¥–∞–ª–µ–Ω–æ:
‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å test_user_1700000000 –∏–∑ –ø–∞–Ω–µ–ª–∏
‚Ä¢ 1 –∑–∞–ø–∏—Å—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users
‚Ä¢ 3 –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã payments
‚Ä¢ FSM state —Å–±—Ä–æ—à–µ–Ω

–ú–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç-–∫–µ–π—Å
```

---

### ‚ÑπÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–µ—Å—Ç-–∫–µ–π—Å

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ FSM state
- –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ø–∞–π–ø–ª–∞–π–Ω–∞
- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤

**–í—ã–≤–æ–¥ –±–æ—Ç—É:**
```
üìã –¢–µ–∫—É—â–∏–π —Ç–µ—Å—Ç-–∫–µ–π—Å

–ü—Ä–æ–≥—Ä–µ—Å—Å: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë 80% (4/5 —à–∞–≥–æ–≤)

‚úÖ 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω
   ‚îî‚îÄ test_user_1700000000 (UUID: d509...)

‚úÖ 2. –ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω
   ‚îî‚îÄ Payment ID: 123, Order ID: 2804372329

‚úÖ 3. –°—Å—ã–ª–∫–∞ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞
   ‚îî‚îÄ QRC ID: AS1R000...

‚úÖ 4. –û–ø–ª–∞—Ç–∞ —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞
   ‚îî‚îÄ Status: succeeded

‚è∏Ô∏è 5. –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å

[‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å] [üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å] [üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ]
```

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
bot/
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îî‚îÄ‚îÄ admin/
‚îÇ       ‚îî‚îÄ‚îÄ test_b2p.py          # –ù–æ–≤—ã–π —Ñ–∞–π–ª —Å —Ç–µ—Å—Ç–æ–≤—ã–º –º–µ–Ω—é
‚îú‚îÄ‚îÄ keyboards/
‚îÇ   ‚îî‚îÄ‚îÄ inline/
‚îÇ       ‚îî‚îÄ‚îÄ test_b2p_keyboards.py  # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ states/
‚îÇ   ‚îî‚îÄ‚îÄ test_b2p_states.py       # FSM states –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚îî‚îÄ‚îÄ services/
    ‚îî‚îÄ‚îÄ test_b2p_service.py      # –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π –¥–ª—è —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤
```

### FSM States

```python
from aiogram.fsm.state import State, StatesGroup

class TestB2PStates(StatesGroup):
    # –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
    main_menu = State()

    # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    awaiting_user_creation = State()
    user_created = State()

    # –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
    selecting_subscription_period = State()
    payment_created = State()

    # –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É
    payment_url_created = State()

    # –°–∏–º—É–ª—è—Ü–∏—è –æ–ø–ª–∞—Ç—ã
    payment_simulated = State()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    checking_status = State()

    # –û—á–∏—Å—Ç–∫–∞
    confirming_cleanup = State()
```

### FSM Data Schema

```python
{
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    "test_user_uuid": "d50941b5-504e-448d-9c40-32c9b21c6722",
    "test_user_short_uuid": "abc123",
    "test_username": "test_user_1700000000",
    "test_telegram_id": 123456789,
    "test_user_db_id": 999,

    # –ü–ª–∞—Ç–µ–∂
    "test_payment_id": 123,
    "test_order_id": "2804372329",
    "test_months": 1,
    "test_amount": 300.00,

    # Best2Pay
    "test_qrc_id": "AS1R000KOMEPGAIE9519CB1Q4PGN6ULN",
    "test_pay_url": "https://test.best2pay.net/sbp/pay/...",

    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    "test_started_at": "2025-11-18T12:00:00Z",
    "test_steps_completed": ["user_created", "payment_created", ...]
}
```

### –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã

```python
# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
def get_test_b2p_main_menu(i18n, lang, state_data):
    builder = InlineKeyboardBuilder()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ —à–∞–≥–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
    completed = state_data.get("test_steps_completed", [])

    # –®–∞–≥ 1
    icon = "‚úÖ" if "user_created" in completed else "1Ô∏è‚É£"
    builder.button(text=f"{icon} –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                   callback_data="test_b2p:create_user")

    # –®–∞–≥ 2 (–¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —à–∞–≥–∞ 1)
    if "user_created" in completed:
        icon = "‚úÖ" if "payment_created" in completed else "2Ô∏è‚É£"
        builder.button(text=f"{icon} –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂",
                       callback_data="test_b2p:create_payment")
    else:
        builder.button(text="üîí –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂",
                       callback_data="test_b2p:locked")

    # ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —à–∞–≥–æ–≤

    builder.button(text="‚ÑπÔ∏è –¢–µ–∫—É—â–∏–π —Ç–µ—Å—Ç-–∫–µ–π—Å",
                   callback_data="test_b2p:show_status")
    builder.button(text="üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ",
                   callback_data="test_b2p:cleanup")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É",
                   callback_data="admin:main")

    builder.adjust(1)  # –ü–æ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–µ –≤ —Ä—è–¥
    return builder.as_markup()

# –í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ –ø–æ–¥–ø–∏—Å–∫–∏
def get_subscription_period_keyboard():
    builder = InlineKeyboardBuilder()

    builder.button(text="1 –º–µ—Å—è—Ü - 300‚ÇΩ",
                   callback_data="test_b2p:period:1:300")
    builder.button(text="3 –º–µ—Å—è—Ü–∞ - 850‚ÇΩ",
                   callback_data="test_b2p:period:3:850")
    builder.button(text="6 –º–µ—Å—è—Ü–µ–≤ - 1600‚ÇΩ",
                   callback_data="test_b2p:period:6:1600")
    builder.button(text="12 –º–µ—Å—è—Ü–µ–≤ - 3000‚ÇΩ",
                   callback_data="test_b2p:period:12:3000")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
                   callback_data="test_b2p:main")

    builder.adjust(2, 2, 1)
    return builder.as_markup()
```

### –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π

```python
class TestB2PService:
    """Service for Best2Pay testing pipeline"""

    def __init__(self, settings, panel_service, best2pay_service):
        self.settings = settings
        self.panel = panel_service
        self.b2p = best2pay_service

    async def create_test_user(self, telegram_id: int) -> dict:
        """Create test user in panel and local DB"""
        username = f"test_user_{int(time.time())}"

        # Create in panel
        panel_user = await self.panel.create_user({
            "username": username,
            "telegramId": telegram_id,
            "email": f"{username}@test.local",
            "subscriptionDurationDays": 0,
            "trafficLimitBytes": 10737418240,  # 10GB
            "tags": ["test_user", "bot_test"]
        })

        # Create in local DB
        # ... (implementation)

        return {
            "uuid": panel_user["uuid"],
            "username": username,
            "telegram_id": telegram_id
        }

    async def create_test_payment(self, user_id: int, months: int, amount: float) -> dict:
        """Create test payment and register order in Best2Pay"""
        # Create DB record
        # Register in Best2Pay
        # Return payment data
        pass

    async def create_payment_url(self, order_id: str) -> dict:
        """Generate SBP payment URL"""
        return await self.b2p.create_payment_url(order_id, "sbp")

    async def simulate_payment(self, order_id: str, success: bool = True) -> dict:
        """Trigger test case in Best2Pay"""
        case_id = "150" if success else "151"
        return await self.b2p.trigger_test_case(order_id=order_id, case_id=case_id)

    async def check_subscription_status(self, user_uuid: str) -> dict:
        """Get user status from panel and local DB"""
        panel_data = await self.panel.get_user(user_uuid)
        # Get local DB data
        # Combine and return
        pass

    async def cleanup_test_data(self, user_uuid: str, user_db_id: int):
        """Delete test user and related data"""
        # Delete from panel
        await self.panel.delete_user(user_uuid)

        # Delete from local DB
        # ... (implementation)
        pass
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

### –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –¥–µ–π—Å—Ç–≤–∏–π

1. **–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã:** –í—Å–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å `IsAdminFilter()`
2. **–¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—è—Ç—å `BEST2PAY_API_URL` —Å–æ–¥–µ—Ä–∂–∏—Ç `test.best2pay.net`
3. **–¢–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —Ç–µ–≥ `test_user`
4. **–ò–∑–æ–ª—è—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –ë–î –∏–ª–∏ schema –¥–ª—è —Ç–µ—Å—Ç–æ–≤

### –í–∞–ª–∏–¥–∞—Ü–∏—è FSM –¥–∞–Ω–Ω—ã—Ö

```python
def validate_test_state(state_data: dict, required_keys: list) -> bool:
    """Validate that all required keys exist in FSM state"""
    return all(key in state_data for key in required_keys)

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
if not validate_test_state(state_data, ["test_user_uuid", "test_payment_id"]):
    await callback.answer("‚ö†Ô∏è –ù–µ –≤—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã", show_alert=True)
    return
```

---

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤

```python
logging.info(
    f"[TEST_B2P] User created: username={username}, "
    f"uuid={uuid}, telegram_id={telegram_id}"
)

logging.info(
    f"[TEST_B2P] Payment created: payment_id={payment_id}, "
    f"order_id={order_id}, amount={amount}, months={months}"
)

logging.info(
    f"[TEST_B2P] Payment simulated: order_id={order_id}, "
    f"case_id={case_id}, success={success}"
)
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ª–æ–≥-—á–∞—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```python
# –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ admin log chat
await bot.send_message(
    chat_id=settings.LOG_CHAT_ID,
    text=(
        f"üß™ <b>Test B2P: –£—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç-–∫–µ–π—Å</b>\n\n"
        f"–ê–¥–º–∏–Ω: {admin_name}\n"
        f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {username}\n"
        f"–ü–ª–∞—Ç–µ–∂: {amount} RUB –∑–∞ {months} –º–µ—Å.\n"
        f"–°—Ç–∞—Ç—É—Å: ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞"
    ),
    parse_mode="HTML"
)
```

---

## –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- [ ] –ü–æ–¥–Ω—è—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
- [ ] –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ø–∞–Ω–µ–ª—å Remnawave
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–æ—Ç–∞ –≤ BotFather
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ë–î
- [ ] –ü–æ–ª—É—á–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∫—Ä–µ–¥—ã Best2Pay (–µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook URL (ngrok –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ–º–µ–Ω)

### –≠—Ç–∞–ø 2: –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–¥–∞
- [ ] –°–æ–∑–¥–∞—Ç—å FSM states (`test_b2p_states.py`)
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (`test_b2p_keyboards.py`)
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π (`test_b2p_service.py`)
- [ ] –°–æ–∑–¥–∞—Ç—å —Ö–µ–Ω–¥–ª–µ—Ä—ã (`test_b2p.py`)
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–æ—É—Ç–µ—Ä –≤ admin router aggregate
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é (ru/en)

### –≠—Ç–∞–ø 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ü—Ä–æ–π—Ç–∏ –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
- [ ] –ü—Ä–æ–π—Ç–∏ –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –Ω–µ—É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å edge cases (–¥—É–±–ª–∏, –æ—à–∏–±–∫–∏ API, –∏ —Ç.–¥.)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–∏—Å—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

### –≠—Ç–∞–ø 4: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –°–æ–∑–¥–∞—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å API –≤—ã–∑–æ–≤—ã
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### Python –ø–∞–∫–µ—Ç—ã
```txt
aiogram>=3.0.0
aiohttp>=3.8.0
sqlalchemy>=2.0.0
pydantic>=2.0.0
```

### –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
- Remnawave Panel API
- Best2Pay Test API
- PostgreSQL database
- Telegram Bot API

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏—á–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 1. –ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤
–°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—Å–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `test_cases`:

```sql
CREATE TABLE test_cases (
    id SERIAL PRIMARY KEY,
    admin_id BIGINT NOT NULL,
    test_user_uuid VARCHAR(255),
    test_username VARCHAR(255),
    payment_id INTEGER,
    order_id VARCHAR(255),
    amount DECIMAL(10, 2),
    months INTEGER,
    status VARCHAR(50),  -- success, failed, incomplete
    steps_completed TEXT[],
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP
);
```

### 2. –ú–∞—Å—Å–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ó–∞–ø—É—Å–∫ N —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–ª—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 3. –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –≤ CSV/JSON —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤

### 4. Webhook inspector
–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–µ–±—Ö—É–∫–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
```
üì® –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–µ–±—Ö—É–∫ Best2Pay:

–í—Ä–µ–º—è: 2025-11-18 12:00:05
–ú–µ—Ç–æ–¥: POST
Path: /webhook/best2pay/notify
IP: 185.xxx.xxx.xxx

Body (XML):
<?xml version="1.0"?>
<operation>
  <order_id>2804372329</order_id>
  ...
</operation>

–ü–æ–¥–ø–∏—Å—å: ‚úÖ –í–∞–ª–∏–¥–Ω–∞
–û–±—Ä–∞–±–æ—Ç–∫–∞: ‚úÖ –£—Å–ø–µ—à–Ω–∞ (200ms)
```

---

## –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç –∑–∞–ø—É—Å–∫–∞

### –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã:
- [ ] –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã
- [ ] .env –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] Webhook –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ
- [ ] –ê–¥–º–∏–Ω ID –ø—Ä–æ–ø–∏—Å–∞–Ω
- [ ] –¢–µ—Å—Ç–æ–≤—ã–µ –∫—Ä–µ–¥—ã Best2Pay –ø–æ–ª—É—á–µ–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø–∞–Ω–µ–ª–∏
curl -H "Authorization: Bearer <API_KEY>" \
  https://test-panel.example.com/api/users

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Best2Pay
curl -X POST https://test.best2pay.net/webapi/Register \
  -d "sector=8365&..."

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
curl https://test-webhook.example.com/webhook/best2pay/notify

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î
psql -U postgres -d test_bot_db -c "SELECT COUNT(*) FROM users;"
```

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞: `docker compose logs -f remnawave-tg-shop`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–∞–Ω–µ–ª–∏
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é Best2Pay
4. –°–æ–∑–¥–∞—Ç—å issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

---

**–í–µ—Ä—Å–∏—è:** 1.0
**–î–∞—Ç–∞:** 2025-11-18
**–ê–≤—Ç–æ—Ä:** AI Assistant
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
