# Best2Pay (–°–ë–ü) Integration

## –û–±–∑–æ—Ä

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Best2Pay –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ –°–∏—Å—Ç–µ–º—É –ë—ã—Å—Ç—Ä—ã—Ö –ü–ª–∞—Ç–µ–∂–µ–π (–°–ë–ü) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º QR-–∫–æ–¥–æ–≤.

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

```bash
# Best2Pay Payment Gateway Configuration (–°–ë–ü support)
BEST2PAY_SECTOR_ID=22436                # –ù–æ–º–µ—Ä —Å–µ–∫—Ç–æ—Ä–∞
BEST2PAY_PASSWORD=X5e87TgD              # –ü–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
BEST2PAY_ENABLED=True                    # –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook URL –≤ –∫–∞–±–∏–Ω–µ—Ç–µ Best2Pay

URL –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: `https://wh.tunnl.space/202321/best2pay/notify`

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: Success URL –∏ Fail URL –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ API, –æ—Ç–¥–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –î–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫–∞–∑–∞** (`webapi/Register`)
   - –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ –ë–î
   - –ó–∞–∫–∞–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ Best2Pay
   - –ü–æ–ª—É—á–∞–µ–º `order_id`

2. **–°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É** (`webapi/PurchaseSBP`)
   - –°–æ–∑–¥–∞–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ —Å QR-–∫–æ–¥–æ–º –°–ë–ü
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã

3. **Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** (XML —Ñ–æ—Ä–º–∞—Ç)
   - Best2Pay –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç XML —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –ø–ª–∞—Ç–µ–∂–∞
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å—å
   - –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞

## –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥–ø–∏—Å–∏

Best2Pay –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **SHA256 + Base64** (–ù–ï MD5!):

1. –ö–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ + –ø–∞—Ä–æ–ª—å
2. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ SHA256 (hex lowercase)
3. –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Base64

### –ü—Ä–∏–º–µ—Ä—ã –ø–æ–¥–ø–∏—Å–∏

**–î–ª—è Register:**
```
sector + amount + currency + password
```

**–î–ª—è PurchaseSBP:**
```
sector + order_id + password
```

**–î–ª—è webhook (–≤—Å–µ —Ç–µ–≥–∏):**
```
order_id + order_state + reference + id + date + type + state + ... + password
```

## –§–æ—Ä–º–∞—Ç webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

Best2Pay –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ **XML —Ñ–æ—Ä–º–∞—Ç–µ**:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<operation>
  <order_id>123</order_id>
  <order_state>COMPLETED</order_state>
  <reference>456</reference>
  <id>789</id>
  <date>2024.10.14 12:00:00</date>
  <type>PURCHASE_BY_QR</type>
  <state>APPROVED</state>
  <amount>10000</amount>
  <currency>643</currency>
  <signature>...</signature>
</operation>
```

## Endpoints

### Webhook URLs

- **Notify (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö)**: `/202321/best2pay/notify`
  - –ú–µ—Ç–æ–¥: POST
  - –§–æ—Ä–º–∞—Ç: XML
  - –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏

- **Success (—É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞)**: `/202321/best2pay/success`
  - –ú–µ—Ç–æ–¥: GET/POST
  - –†–µ–¥–∏—Ä–µ–∫—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

- **Fail (–Ω–µ—É–¥–∞—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞)**: `/202321/best2pay/fail`
  - –ú–µ—Ç–æ–¥: GET/POST
  - –†–µ–¥–∏—Ä–µ–∫—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –§–∞–π–ª—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **bot/services/best2pay_service.py**
   - Best2PayService –∫–ª–∞—Å—Å
   - register_order() - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫–∞–∑–∞
   - create_payment_url() - —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –°–ë–ü
   - verify_signature() - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
   - Webhook handlers

2. **bot/handlers/user/subscription/payments.py**
   - pay_best2pay_callback_handler() - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã

3. **bot/app/web/web_server.py**
   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è webhook –º–∞—Ä—à—Ä—É—Ç–æ–≤

4. **bot/app/factories/build_services.py**
   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞

5. **bot/keyboards/inline/user_keyboards.py**
   - –ö–Ω–æ–ø–∫–∞ "üí≥ Best2Pay (–°–ë–ü)"

6. **config/settings.py**
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ webhook paths

## –ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã

### –°–æ —Å—Ç–æ—Ä–æ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ø–µ—Ä–∏–æ–¥ –ø–æ–¥–ø–∏—Å–∫–∏
2. –í—ã–±–∏—Ä–∞–µ—Ç "Best2Pay (–°–ë–ü)"
3. –ü–æ–ª—É—á–∞–µ—Ç —Å—Å—ã–ª–∫—É —Å QR-–∫–æ–¥–æ–º
4. –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥ –±–∞–Ω–∫–æ–≤—Å–∫–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
5. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—É
6. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞

### –°–æ —Å—Ç–æ—Ä–æ–Ω—ã —Å–∏—Å—Ç–µ–º—ã:

1. –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ –ë–î (status: pending_best2pay)
2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –∑–∞–∫–∞–∑ –≤ Best2Pay ‚Üí –ø–æ–ª—É—á–∞–µ–º order_id
3. –°–æ–∑–¥–∞–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –°–ë–ü ‚Üí redirect –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. Best2Pay –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç XML webhook ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
5. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
6. –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ/–ø—Ä–æ–º–æ –±–æ–Ω—É—Å—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
python3 -c "
from bot.services.best2pay_service import Best2PayService
from config.settings import Settings

settings = Settings()
service = Best2PayService(settings)

print(f'Configured: {service.configured}')
print(f'Sector ID: {service.sector_id}')
print(f'API URL: {service.api_url}')
"
```

### 2. –¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç: `docker compose restart`
2. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞
3. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –ø–æ–¥–ø–∏—Å–∫–∏
4. –ù–∞–∂–º–∏—Ç–µ "Best2Pay (–°–ë–ü)"
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞
6. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –æ–ø–ª–∞—Ç—É

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ:
```
Best2Pay notify webhook received XML
Best2Pay notify: order_id=..., state=APPROVED
```

## Troubleshooting

### –û—à–∏–±–∫–∞ "Invalid signature"

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å –≤ .env (X5e87TgD)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SHA256 + Base64, –∞ –Ω–µ MD5
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ç–µ–≥–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ

### –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–∫–∞–∑–∞

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SECTOR_ID (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 22436)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API: https://pay.best2pay.net/webapi/
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è Register

### Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ –∫–∞–±–∏–Ω–µ—Ç–µ Best2Pay: `https://wh.tunnl.space/202321/best2pay/notify`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞

### –ü–ª–∞—Ç–µ–∂ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–∏ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å APPROVED)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ reference (payment_db_id) –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Best2Pay

- –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: B2P+API+-+–û–±—â–∞—è+v2.18.1-compressed.pdf
- input.md - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API –≤ markdown

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –õ–æ–≥–∏ –±–æ—Ç–∞ (docker logs)
2. –õ–æ–≥–∏ Best2Pay –≤ –∫–∞–±–∏–Ω–µ—Ç–µ
3. –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–µ–π –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ payments)

## –ó–∞–º–µ—Ç–∫–∏

- –°–ë–ü = –°–∏—Å—Ç–µ–º–∞ –ë—ã—Å—Ç—Ä—ã—Ö –ü–ª–∞—Ç–µ–∂–µ–π (Faster Payment System)
- –ö–æ–º–∏—Å—Å–∏—è Best2Pay —É—Ç–æ—á–Ω—è–µ—Ç—Å—è —É –±–∞–Ω–∫–∞
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞: —É—Ç–æ—á–Ω–∏—Ç–µ —É –±–∞–Ω–∫–∞
- –¢–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏: —É—Ç–æ—á–Ω–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É –±–∞–Ω–∫–∞
